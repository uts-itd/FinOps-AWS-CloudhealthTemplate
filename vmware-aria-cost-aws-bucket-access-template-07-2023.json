{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Please do not modify or delete this stack.  This CloudFormation Template creates a policy with the necessary S3 bucket permissions for the CloudHealth billing platform.",
   "Parameters":{
      "CURBucketName":{
         "Type":"String",
         "Description":"Enter the S3 bucket name where AWS CUR files are saved. Please ensure resource IDs are checked and the hourly interval is selected. For set up instructions, please refer to the CloudHealth Help Center: https://help.cloudhealthtech.com.",
         "MaxLength":"63"
      },
      "CURBucketPath":{
         "Type":"String",
         "Description":"Enter the S3 bucket path where AWS CUR files are stored before the dates (example: if the path is 'cost-and-usage/curdata/20191101-20191201', you will fill in 'cost-and-usage/curdata').",
         "MaxLength":"90"
      },
      "S3BucketWrite":{
         "Type":"String",
         "Description":"Enter the S3 bucket where you wish CloudHealth to have write access (example: deliver the cost history report weekly to a specified bucket).",
         "MaxLength":"63"
      }
   },
   "Resources":{
      "Policy":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "ManagedPolicyName":"CloudHealth-Bucket-Access-Policy",
            "Description":"CloudHealth Billing and Reporting",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"CURBucketName"
                                 }
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"CURBucketName"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "s3:Put*"
                     ],
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"S3BucketWrite"
                                 }
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"S3BucketWrite"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            },
            "Roles":[
               "CloudHealth-Access"
            ]
         }
      }
   },
   "Outputs":{
      "CURBucketName":{
         "Value":{
            "Ref":"CURBucketName"
         }
      },
      "CURBucketPath":{
         "Value":{
            "Ref":"CURBucketPath"
         }
      },
      "S3BucketWrite":{
         "Value":{
            "Ref":"S3BucketWrite"
         }
      }
   }
}